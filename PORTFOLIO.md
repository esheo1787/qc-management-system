# QC Management System

**의료 영상 세그멘테이션 작업의 품질 관리 및 AI-Human QC 협업을 위한 웹 기반 시스템**

| 항목 | 내용 |
|------|------|
| 프로젝트명 | QC Management System |
| 개발 기간 | 2026.01 ~ |
| 개발 인원 | 1인 |
| 테스트 | 77 tests passed |

> **핵심 메시지**
> "AI 자동 검수(Auto-QC) 결과를 사람이 검증하고, 불일치 패턴을 분석하여 검수 기준을 개선하는 구조"

---

## 1. 프로젝트 배경 및 목적

### 배경

의료 영상 AI 모델 학습을 위해서는 정확한 세그멘테이션 데이터가 필수입니다.
하지만 대량의 데이터를 수작업으로 검수하는 것은 비효율적이며, AI 자동 검수만으로는 한계가 있습니다.

| 검수 방식 | 장점 | 한계 |
|-----------|------|------|
| **사람 검수** | 맥락 이해, 예외 상황 판단 | 시간/비용 소요, 검수자 간 편차 |
| **AI 검수** | 빠른 속도, 일관된 기준 | 새로운 오류 패턴 대응 어려움 |

### 목적

**AI와 사람이 협업하는 QC 체계**를 구축하여:

1. **AI 자동 검수(Auto-QC)** 로 1차 필터링 → 검수 효율화
2. **사람의 검증**으로 AI가 놓친 문제 보완
3. **불일치 패턴 분석**을 통해 검수 기준 및 자동화 로직 지속 개선

---

## 2. 시스템 구조: AI-Human QC 협업 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        QC 협업 사이클                                    │
└─────────────────────────────────────────────────────────────────────────┘

  ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
  │  Pre-QC  │────▶│  작업자  │────▶│ Auto-QC  │────▶│  검수자  │
  │  (자동)  │     │   작업   │     │  (자동)  │     │  (사람)  │
  └──────────┘     └──────────┘     └──────────┘     └────┬─────┘
       │                                                   │
       │                                                   ▼
       │                                          ┌───────────────┐
       │                                          │  승인 / 재작업 │
       │                                          └───────┬───────┘
       │                                                   │
       │               ┌───────────────────────────────────┘
       │               ▼
       │        ┌─────────────┐
       │        │ 불일치 분석  │◀─── AI vs 사람 판단 비교
       │        └──────┬──────┘
       │               │
       │               ▼
       │        ┌─────────────┐
       └────────│ 기준 개선   │───▶ QC 기준 / 자동화 로직 업데이트
                └─────────────┘
```

### 단계별 설명

| 단계 | 주체 | 내용 |
|------|------|------|
| **Pre-QC** | 자동 | 작업 전 데이터 품질 분석 (난이도, 노이즈, 조영제, 아티팩트 등) |
| **작업** | 작업자 | 세그멘테이션 수행 |
| **Auto-QC** | 자동 | 작업 결과 자동 검증 → **PASS / WARN / INCOMPLETE** 판정 |
| **검수** | 검수자 | Auto-QC 결과 확인 → **승인 / 재작업 요청** |
| **불일치 기록** | 검수자 | Auto-QC와 사람 판단이 다른 경우 기록 |
| **기준 개선** | 운영자 | 불일치 패턴 분석 → QC 기준 및 자동화 로직 개선 |

### 불일치 유형 정의

| 유형 | 정의 | 의미 |
|------|------|------|
| **놓친 문제 (Missed)** | Auto-QC가 PASS 판정 → 사람이 문제 발견 | Auto-QC 검출 기준 강화 필요 |
| **잘못된 경고 (False Alarm)** | Auto-QC가 WARN 판정 → 사람이 확인 후 문제없음 | Auto-QC 기준 완화 또는 예외 처리 필요 |

---

## 3. 주요 기능

### 케이스 관리
- 케이스 등록/조회/수정
- 작업자 배정 및 재배정
- 상태 추적: `TODO → IN_PROGRESS → SUBMITTED → ACCEPTED/REWORK`
- 이벤트 로그: 모든 상태 변경 이력 기록

### QC 워크플로우

#### 작업자 화면
| 기능 | 설명 |
|------|------|
| Auto-QC 이슈 수정 체크 | 각 이슈별 "수정 완료" 체크박스 |
| 추가 수정 사항 기록 | Auto-QC가 탐지하지 못한 문제 직접 기록 |
| 수정 유형 선택 | 놓친 문제 / 잘못된 경고 구분 |

#### 검수자 화면
| 기능 | 설명 |
|------|------|
| Auto-QC 이슈 확인 체크 | 작업자 수정 내역 확인 체크박스 |
| 추가 수정 확인 체크 | 작업자가 추가 기록한 수정 사항 확인 |
| 불일치 기록 | Auto-QC와 다른 판단 시 유형/세그먼트/상세 기록 |
| 승인 / 재작업 결정 | 최종 판정 |

### QC 불일치 분석 탭

```
┌─────────────────────────────────────────────────────────┐
│  기간: 2026-01-01 ~ 2026-01-31                          │
├─────────────────────────────────────────────────────────┤
│  불일치 건수: 15건                                       │
│  ├─ 놓친 문제: 10건 (66.7%)                             │
│  └─ 잘못된 경고: 5건 (33.3%)                            │
├─────────────────────────────────────────────────────────┤
│  세그먼트별 불일치 통계                                   │
│  ┌──────────┬──────────┬──────────┬──────┐             │
│  │ 세그먼트  │ 놓친 문제 │ 잘못된 경고│ 총계 │             │
│  ├──────────┼──────────┼──────────┼──────┤             │
│  │ IVC      │    4     │    2     │   6  │             │
│  │ Aorta    │    3     │    1     │   4  │             │
│  │ Portal   │    2     │    2     │   4  │             │
│  └──────────┴──────────┴──────────┴──────┘             │
└─────────────────────────────────────────────────────────┘
```

**분석 인사이트 예시:**
- IVC 세그먼트에서 "놓친 문제"가 많음 → Auto-QC 검출 기준 강화 필요
- Portal 세그먼트에서 "잘못된 경고" 비율 높음 → 오탐 기준 완화 검토

### 작업 통계 대시보드

| 탭 | 지표 |
|-----|------|
| **성과** | 완료 건수, 재작업 건수, 1차 통과율, 평균 작업 시간 |
| **분포** | 병원별/부위별/상태별 케이스 분포 |
| **가동률** | 근무일 수, 실제 작업 시간, 가동률(%) |

---

## 4. 기술 스택

| 분류 | 기술 | 역할 |
|------|------|------|
| **Backend** | FastAPI | REST API 서버 |
| **ORM** | SQLAlchemy 2.0 | 데이터베이스 접근 |
| **Database** | SQLite (WAL) | 데이터 저장 |
| **Frontend** | Streamlit | 대시보드 UI |
| **Testing** | pytest | 자동화 테스트 (77 tests) |
| **문서화** | Swagger (OpenAPI) | API 명세 자동 생성 |

### 아키텍처

```
┌─────────────┐
│  Streamlit  │  ← UI Layer
└──────┬──────┘
       │
┌──────▼──────┐
│   FastAPI   │  ← Router Layer (요청 검증, 응답 직렬화)
│   (api/*.py)│
└──────┬──────┘
       │
┌──────▼──────┐
│   Service   │  ← Business Logic (트랜잭션, 규칙 적용)
│(services.py)│
└──────┬──────┘
       │
┌──────▼──────┐
│   Model     │  ← Data Access (ORM)
│ (models.py) │
└──────┬──────┘
       │
┌──────▼──────┐
│   SQLite    │  ← Database
└─────────────┘
```

---

## 5. 설계 원칙 및 구현 특징

### API 계약 기반 개발
- Pydantic 스키마로 요청/응답 명확히 정의
- 기능 변경 없이 내부 리팩토링 가능
- Swagger UI로 API 문서 자동 생성

### 단일 집계 함수 (SSOT)
```python
def _get_reviewer_disagreement_stats(db, start_date, end_date):
    """QC 불일치 통계 - 단일 진실 공급원"""
    # 요약 수치와 상세 목록이 동일한 기준으로 계산됨
    return {
        "total_count": ...,
        "missed_count": ...,
        "false_alarm_count": ...,
        "missed_records": [...],
        "segment_stats": {...}
    }
```
→ 요약/상세 화면 간 수치 불일치 방지

### 테스트 안정성
- 트랜잭션 격리: 각 테스트가 독립적으로 실행
- 77개 테스트 100% 통과 유지
- 리팩토링 시 회귀 방지

### 저장 후 재조회 패턴
```python
# 저장
db.commit()
# 화면 갱신
st.rerun()  # DB에서 다시 조회하여 표시
```
→ UI 상태와 DB 상태 불일치 방지

---

## 6. 이 프로젝트를 통해 경험한 것

### AI-Human QC 협업 구조 설계
- Auto-QC의 역할과 한계 정의
- 사람 검수가 필요한 지점 식별
- 두 주체 간 역할 분담 설계

### 오류 유형 분류 체계 정의
- "놓친 문제" vs "잘못된 경고" 이분법적 분류
- 각 유형이 의미하는 개선 방향 정의
- 세그먼트별 분류로 구체적 개선 포인트 도출

### 불일치 데이터 수집 → 분석 → 기준 개선 사이클
```
수집: 검수자가 불일치 발견 시 유형/세그먼트/상세 기록
  ↓
분석: 기간별/세그먼트별 불일치 통계 집계
  ↓
개선: 빈발 패턴 → QC 기준 또는 Auto-QC 로직 수정
  ↓
검증: 개선 후 불일치율 변화 모니터링
```

### QC 워크플로우 시스템화
- 암묵적이던 검수 프로세스를 명시적 워크플로우로 정의
- 체크박스/기록 UI로 SOP 준수 유도
- 이벤트 로그로 모든 과정 추적 가능

---

## 7. 스크린샷

> 스크린샷은 추후 추가 예정입니다.

| 화면 | 설명 |
|------|------|
| 작업자 화면 | Auto-QC 이슈 수정 체크, 추가 수정 기록 |
| 검수자 화면 | 수정 확인 체크, 불일치 기록, 승인/재작업 |
| QC 불일치 분석 | 기간별 통계, 세그먼트별 분포 |
| 성과 대시보드 | 완료율, 재작업률, 작업자별 성과 |

---

## 연락처

- GitHub: [esheo1787](https://github.com/esheo1787)
